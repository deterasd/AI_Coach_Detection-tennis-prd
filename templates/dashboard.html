<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coach Validation Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --bg-color: #050505;
            --card-bg: rgba(20, 20, 20, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --accent-primary: #6366f1;
            --accent-secondary: #a855f7;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 15% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 35%),
                radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.15) 0%, transparent 35%);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
        }

        h1 {
            font-weight: 800;
            font-size: 2rem;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0 0 8px 0;
        }

        .subtitle {
            color: var(--text-sub);
            font-size: 1rem;
        }

        /* Layout Grid */
        .dashboard-grid {
            display: grid;
            /* èª¿æ•´å·¦å³æ¬„ä½æ¯”ä¾‹: 350px (å·¦å´å›ºå®š) 1fr (å³å´è‡ªå‹•) æˆ–æ”¹ç‚º 1fr 3fr (æ¯”ä¾‹) */
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* New Step Badge Style */
        .step-badge {
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            padding: 6px 10px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.1);
        }

        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: 500;
        }

        select, textarea, input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        select:focus, textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            letter-spacing: 0.02em;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover { 
            opacity: 0.95; 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border-color: var(--card-border);
        }

        .btn-secondary:hover { 
            background: rgba(255, 255, 255, 0.1); 
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .btn-success:hover { 
            background: rgba(52, 211, 153, 0.25); 
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.2);
        }

        /* Overview Grid Styles */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .step-summary-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .step-summary-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 100%;
            justify-content: flex-start;
        }
        
        .step-icon { font-size: 1.1rem; opacity: 0.8; }

        .step-score-container {
            text-align: center;
            margin: 4px 0;
            width: 100%;
        }

        .step-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 6px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-sub);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.7;
        }

        .step-status {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 99px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
        }

        .badge-pending { background: rgba(255, 255, 255, 0.05); color: var(--text-sub); border: 1px solid rgba(255, 255, 255, 0.1); }
        .badge-running { background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); animation: pulse 2s infinite; }
        .badge-success { background: rgba(52, 211, 153, 0.15); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); }
        .badge-warning { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
        .badge-error { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .action-row {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .action-row:hover {
            border-color: rgba(255, 255, 255, 0.15);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            transform: translateX(4px);
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .action-title { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 18px;
            background: var(--accent-secondary);
            border-radius: 2px;
        }

        .action-desc { 
            font-size: 0.95rem; 
            color: var(--text-sub); 
            margin-bottom: 24px; 
            line-height: 1.6;
            padding-left: 14px;
        }

        .status-indicator {
            font-size: 0.85rem;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .status-indicator.visible { opacity: 1; }

        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        hr { border: 0; border-top: 1px solid var(--card-border); margin: 20px 0; }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>AI Coach Validation Dashboard</h1>
        <div class="subtitle">3D ç¶²çƒå‹•ä½œåˆ†æé©—è­‰æ§åˆ¶å°</div>
    </header>

    <div class="dashboard-grid">
        <!-- Left Column: Inputs -->
        <div class="col-left">
            
            <!-- 1. Data Source -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="step-badge">Step 01</span>
                        è³‡æ–™ä¾†æºé¸æ“‡
                    </div>
                    <button class="btn btn-secondary refresh-btn" onclick="loadFolders()">
                        â†» é‡æ–°æ•´ç†
                    </button>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡è³‡æ–™å¤¾ (Folder)</label>
                    <select id="folder-select" onchange="loadFiles(this.value)">
                        <option value="" disabled selected>è«‹é¸æ“‡è³‡æ–™å¤¾...</option>
                    </select>
                </div>

                <hr>

                <div class="grid-3">
                    <div class="form-group">
                        <label>3D Trajectory JSON (ä¸»è¦)</label>
                        <select id="file-3d"></select>
                    </div>
                    <div class="form-group">
                        <label>2D Side JSON</label>
                        <select id="file-side"></select>
                    </div>
                    <div class="form-group">
                        <label>2D 45Â° JSON</label>
                        <select id="file-45"></select>
                    </div>
                </div>
            </div>

            <!-- 2. Camera Params -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="step-badge">Step 02</span>
                        ç›¸æ©Ÿåƒæ•¸è¨­å®š
                    </div>
                </div>

                <!-- Config Management -->
                <div class="form-group" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <label style="margin-bottom: 10px;">å¿«é€Ÿè¨­å®š (Quick Config)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="config-select" onchange="loadConfig(this.value)" style="flex: 1;">
                            <option value="" disabled selected>é¸æ“‡è¨­å®šæª”...</option>
                        </select>
                        <button class="btn btn-secondary" onclick="deleteConfig()" title="åˆªé™¤ç›®å‰è¨­å®š">ğŸ—‘ï¸</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-config-name" placeholder="è¼¸å…¥æ–°è¨­å®šåç¨±..." style="flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--card-border); background: rgba(0,0,0,0.3); color: var(--text-main);">
                        <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>P1 Matrix (Side Camera)</label>
                        <textarea id="p1-matrix" rows="4">
[[917.153880, 0.000000, 994.529968, 0.000000],
 [0.000000, 920.803487, 531.057076, 0.000000],
 [0.000000, 0.000000, 1.000000, 0.000000]]
                        </textarea>
                    </div>
                    <div class="form-group">
                        <label>P2 Matrix (45Â° Camera)</label>
                        <textarea id="p2-matrix" rows="4">
[[286.476533, 43.805594, 1301.943509, -765436.820164],
 [-309.560886, 957.641377, 401.534167, 365723.173062],
 [-0.553187, 0.008475, 0.833014, 660.964347]]
                        </textarea>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Column: Execution -->
        <div class="col-right">
            
            <!-- Overview Card -->
            <div class="card" id="overview-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="step-badge">Overview</span>
                        åˆ†æçµæœç¸½è¦½
                    </div>
                </div>
                <div class="overview-grid">
                    <!-- Step 1 -->
                    <div class="step-summary-card" id="overview-step1">
                        <div class="step-header">
                            <span class="step-icon">ğŸ“</span>
                            <span class="step-name">Step 1</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Reprojection</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                    <!-- Step 2 -->
                    <div class="step-summary-card" id="overview-step2">
                        <div class="step-header">
                            <span class="step-icon">ğŸ¦´</span>
                            <span class="step-name">Step 2</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Bone Consistency</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                    <!-- Step 3 -->
                    <div class="step-summary-card" id="overview-step3">
                        <div class="step-header">
                            <span class="step-icon">ğŸŒŠ</span>
                            <span class="step-name">Step 3</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Depth Logic</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                    <!-- Step 4 -->
                    <div class="step-summary-card" id="overview-step4">
                        <div class="step-header">
                            <span class="step-icon">âš¡</span>
                            <span class="step-name">Step 4</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Physical Motion</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                    <!-- Step 5 -->
                    <div class="step-summary-card" id="overview-step5">
                        <div class="step-header">
                            <span class="step-icon">ğŸ§Š</span>
                            <span class="step-name">Step 5</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Spatial Consistency</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                    <!-- Step 6 -->
                    <div class="step-summary-card" id="overview-step6">
                        <div class="step-header">
                            <span class="step-icon">â±ï¸</span>
                            <span class="step-name">Step 6</span>
                        </div>
                        <div class="step-score-container">
                            <div class="step-score">--</div>
                            <div class="step-label">Time Smoothness</div>
                        </div>
                        <div class="step-status badge-pending">Pending</div>
                    </div>
                </div>
            </div>

            <!-- 3. Execution -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="step-badge">Step 03</span>
                        åŸ·è¡Œé©—è­‰åˆ†æ
                    </div>
                </div>

                <!-- Global Actions -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="clearAllSettings()">
                        ğŸ—‘ï¸ æ¸…ç©ºè¨­å®š
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="runAllTests()">
                        ğŸš€ ä¸€éµåŸ·è¡Œå…¨éƒ¨
                    </button>
                </div>

                <!-- Step 1 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 1 é‡æŠ•å½±èª¤å·®é©—è­‰</div>
                    </div>
                    <div class="action-desc">é©—è­‰ 3D é‡å»ºçµæœèˆ‡ 2D è§€æ¸¬é»çš„æŠ•å½±èª¤å·®ï¼Œæª¢æŸ¥ç›¸æ©Ÿæ ¡æ­£æº–ç¢ºåº¦ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step1" class="btn btn-primary" onclick="runStep1()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step1" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step1" class="btn btn-secondary" style="display:none;" onclick="downloadReport(1)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step1" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 2 éª¨æ¶ä¸€è‡´æ€§é©—è­‰</div>
                    </div>
                    <div class="action-desc">åˆ†æéª¨éª¼é•·åº¦è®Šç•°ã€å·¦å³å°ç¨±æ€§åŠå‹•ä½œå¹³æ»‘åº¦ï¼Œç¢ºä¿ç”Ÿç‰©åŠ›å­¸åˆç†æ€§ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step2" class="btn btn-primary" onclick="runStep2()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step2" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step2" class="btn btn-secondary" style="display:none;" onclick="downloadReport(2)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step2" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Step 3 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 3 æ·±åº¦åˆç†æ€§é©—è­‰</div>
                    </div>
                    <div class="action-desc">æª¢æŸ¥å…¨èº«é—œç¯€æ·±åº¦ç©©å®šåº¦ã€å·¦å³å°ç¨±å·®ç•°èˆ‡è…•/è†ç­‰é‚è¼¯é•è¦æ¯”ä¾‹ï¼Œè©•ä¼°3Dæ·±åº¦å¯ä¿¡åº¦ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step3" class="btn btn-primary" onclick="runStep3()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step3" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step3" class="btn btn-secondary" style="display:none;" onclick="downloadReport(3)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step3" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Step 4 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 4 ç‰©ç†é‹å‹•åˆç†æ€§é©—è­‰</div>
                    </div>
                    <div class="action-desc">æª¢æŸ¥é€Ÿåº¦ã€åŠ é€Ÿåº¦æ˜¯å¦ç¬¦åˆäººé«”æ¥µé™ï¼Œä¸¦åµæ¸¬ç•°å¸¸æŠ–å‹• (Jitter)ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step4" class="btn btn-primary" onclick="runStep4()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step4" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step4" class="btn btn-secondary" style="display:none;" onclick="downloadReport(4)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step4" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Step 5 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 5 ç©ºé–“ä¸€è‡´æ€§é©—è­‰</div>
                    </div>
                    <div class="action-desc">é©—è­‰éª¨æ¶åœ¨ç©ºé–“ä¸­çš„å¹¾ä½•é—œä¿‚ï¼Œç¢ºä¿ç„¡ç©¿æ¨¡æˆ–ç•°å¸¸æ‰­æ›²ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step5" class="btn btn-primary" onclick="runStep5()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step5" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step5" class="btn btn-secondary" style="display:none;" onclick="downloadReport(5)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step5" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Step 6 Action -->
                <div class="action-row">
                    <div class="action-header">
                        <div class="action-title">Step 6 æ™‚é–“å¹³æ»‘åº¦é©—è­‰</div>
                    </div>
                    <div class="action-desc">åˆ†æå‹•ä½œåœ¨æ™‚é–“è»¸ä¸Šçš„é€£çºŒæ€§ï¼Œç¢ºä¿ç„¡ç¬ç§»æˆ–æ‰å¹€ã€‚</div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <button id="btn-run-step6" class="btn btn-primary" onclick="runStep6()">
                            åŸ·è¡Œåˆ†æ
                        </button>
                        <a id="btn-view-step6" class="btn btn-success view-btn" target="_blank">
                            æª¢è¦–å ±å‘Š
                        </a>
                        <button id="btn-download-step6" class="btn btn-secondary" style="display:none;" onclick="downloadReport(6)">
                            ä¸‹è¼‰é›¢ç·šå ±å‘Š
                        </button>
                        <div id="status-step6" class="status-indicator">
                            <div class="spinner"></div> <span>åŸ·è¡Œä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let cameraConfigs = {};
    window.step1Result = null;
    window.step2Result = null;
    window.step3Result = null;
    window.step4Result = null;
    window.step5Result = null;
    window.step6Result = null;

    async function loadConfigs() {
        try {
            const response = await fetch('/api/camera-settings');
            cameraConfigs = await response.json();
            const select = document.getElementById('config-select');
            // Keep current selection if possible
            const currentVal = select.value;
            
            select.innerHTML = '<option value="" disabled selected>é¸æ“‡è¨­å®šæª”...</option>';
            
            Object.keys(cameraConfigs).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.text = name;
                select.appendChild(option);
            });
            
            if (currentVal && cameraConfigs[currentVal]) {
                select.value = currentVal;
            }
        } catch (error) {
            console.error('Error loading configs:', error);
        }
    }

    function loadConfig(name) {
        if (cameraConfigs[name]) {
            const config = cameraConfigs[name];
            
            // Custom formatter to keep rows on single lines
            const formatMatrix = (matrix) => {
                if (!Array.isArray(matrix)) return JSON.stringify(matrix, null, 4);
                return '[\n' + matrix.map(row => '    ' + JSON.stringify(row).replace(/,/g, ', ')).join(',\n') + '\n]';
            };

            document.getElementById('p1-matrix').value = formatMatrix(config.p1);
            document.getElementById('p2-matrix').value = formatMatrix(config.p2);
        }
    }

    async function saveConfig() {
        const name = document.getElementById('new-config-name').value.trim();
        if (!name) {
            alert('è«‹è¼¸å…¥è¨­å®šåç¨±');
            return;
        }
        
        const matrices = getMatrices();
        if (!matrices) return;

        try {
            const response = await fetch('/api/camera-settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    p1: matrices.p1,
                    p2: matrices.p2
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('è¨­å®šå·²å„²å­˜');
                document.getElementById('new-config-name').value = '';
                loadConfigs(); // Reload list
            } else {
                alert('å„²å­˜å¤±æ•—: ' + result.error);
            }
        } catch (e) {
            alert('å„²å­˜å¤±æ•—: ' + e);
        }
    }

    async function deleteConfig() {
        const select = document.getElementById('config-select');
        const name = select.value;
        if (!name) {
            alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è¨­å®š');
            return;
        }
        
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨­å®š "${name}" å—ï¼Ÿ`)) return;

        try {
            const response = await fetch(`/api/camera-settings/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('è¨­å®šå·²åˆªé™¤');
                loadConfigs(); // Reload list
            } else {
                alert('åˆªé™¤å¤±æ•—: ' + result.error);
            }
        } catch (e) {
            alert('åˆªé™¤å¤±æ•—: ' + e);
        }
    }

    // åˆå§‹åŒ–ï¼šè¼‰å…¥è³‡æ–™å¤¾
    async function loadFolders() {
        try {
            const response = await fetch('/api/folders');
            const data = await response.json();
            const select = document.getElementById('folder-select');
            select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡è³‡æ–™å¤¾...</option>';
            
            if (data.folders) {
                data.folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.text = folder;
                    select.appendChild(option);
                });
                
                // å¦‚æœåªæœ‰ä¸€å€‹è³‡æ–™å¤¾ï¼Œè‡ªå‹•é¸æ“‡
                if (data.folders.length === 1) {
                    select.value = data.folders[0];
                    loadFiles(data.folders[0]);
                }
            }
        } catch (error) {
            console.error('Error loading folders:', error);
            alert('ç„¡æ³•è¼‰å…¥è³‡æ–™å¤¾åˆ—è¡¨ï¼Œè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦å·²å•Ÿå‹•ã€‚');
        }
    }

    // è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
    async function loadFiles(folder) {
        if (!folder) return;
        
        try {
            const response = await fetch(`/api/files?folder=${encodeURIComponent(folder)}`);
            const data = await response.json();
            
            if (data.files) {
                const selects = ['file-3d', 'file-side', 'file-45'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = '';
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.text = file;
                        select.appendChild(option);
                    });
                });

                matchFiles(data.files);
            }
        } catch (error) {
            console.error('Error loading files:', error);
            alert('ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨: ' + error.message);
        }
    }

    function matchFiles(files) {
        const file45 = files.find(f => f.includes("45(2D_trajectory_smoothed)"));
        const fileSide = files.find(f => f.includes("side(2D_trajectory_smoothed)"));
        
        const files3d = files.filter(f => f.includes("(3D_trajectory_smoothed)") && !f.includes("results"));
        files3d.sort((a, b) => a.length - b.length);
        const file3d = files3d.length > 0 ? files3d[0] : null;

        if (fileSide) document.getElementById('file-side').value = fileSide;
        if (file45) document.getElementById('file-45').value = file45;
        if (file3d) document.getElementById('file-3d').value = file3d;
    }

    function getMatrices() {
        const parseMatrix = (id) => {
            let val = document.getElementById(id).value.trim();
            // Remove trailing commas in arrays (e.g., [1, 2,], -> [1, 2])
            val = val.replace(/,\s*]/g, ']').replace(/,\s*}/g, '}');
            return JSON.parse(val);
        };

        try {
            const p1 = parseMatrix('p1-matrix');
            const p2 = parseMatrix('p2-matrix');
            return { p1, p2 };
        } catch (e) {
            console.error(e);
            alert('çŸ©é™£æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„ JSON é™£åˆ—æ ¼å¼ã€‚\n(æç¤º: è«‹æª¢æŸ¥æ˜¯å¦æœ‰å¤šçš„é€—è™Ÿæˆ–æ‹¬è™Ÿä¸åŒ¹é…)');
            return null;
        }
    }

    function setRunningState(step, isRunning) {
        const btn = document.getElementById(`btn-run-step${step}`);
        const status = document.getElementById(`status-step${step}`);
        const viewBtn = document.getElementById(`btn-view-step${step}`);
        const overviewStatus = document.querySelector(`#overview-step${step} .step-status`);

        if (isRunning) {
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';
            status.classList.add('visible');
            viewBtn.style.display = 'none';
            
            if(overviewStatus) {
                overviewStatus.textContent = 'Running';
                overviewStatus.className = 'step-status badge-running';
            }
        } else {
            btn.disabled = false;
            btn.textContent = 'é‡æ–°åŸ·è¡Œ';
            status.classList.remove('visible');
        }
    }

    function setCompleteState(step, resultFile) {
        const viewBtn = document.getElementById(`btn-view-step${step}`);
        let reportPage = '';
        if (step === 1) reportPage = 'step1_reprojection_error.html';
        else if (step === 2) reportPage = 'step2_bone_consistency.html';
        else if (step === 3) reportPage = 'step3_depth_reasonableness.html';
        else if (step === 4) reportPage = 'step4_physical_motion.html';
        else if (step === 5) reportPage = 'step5_spatial_consistency.html';
        else if (step === 6) reportPage = 'step6_time_smoothness.html';
        
        viewBtn.href = `${reportPage}?src=${encodeURIComponent(resultFile)}`;
        viewBtn.style.display = 'inline-flex';

        // Store result for download
        window[`step${step}Result`] = resultFile;
        
        const downloadBtn = document.getElementById(`btn-download-step${step}`);
        if (downloadBtn) downloadBtn.style.display = 'inline-flex';

        // Update Overview
        updateOverview(step, resultFile);
    }

    function calculateFallbackScore(step, data) {
        let score = 100;
        let level = 'Excellent';
        
        // Helper to clamp
        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

        try {
            if (step === 1) {
                // Step 1: Reprojection Error
                const stats = data.global_stats || {};
                const mean = stats.overall_mean || 0;
                if (mean > 2) score -= clamp((mean - 2) * 8, 0, 25);
                
                const q95 = Math.max(stats.side_95th || 0, stats['45_95th'] || 0);
                if (q95 > 6) score -= clamp((q95 - 6) * 2.5, 0, 18);
            } 
            else if (step === 2) {
                // Step 2: Bone Consistency
                const summary = data.overall_summary || {};
                const cv = summary.average_cv || summary.average_cv_percent || 0;
                if (cv > 4) score -= clamp((cv - 4) * 2.2, 0, 22);
                
                const spikes = (data.spike_detection && data.spike_detection.total_spikes) || summary.total_spikes_detected || 0;
                if (spikes > 0) score -= clamp(spikes * 2, 0, 20);
            }
            else if (step === 3) {
                // Step 3: Depth Reasonableness
                const summary = data.overall_summary || {};
                const stats = data.overall_statistics || {};
                const cv = summary.average_cv || stats.average_cv_percent || 0;
                if (cv > 10) score -= 20;
                else if (cv > 5) score -= 10;
                
                const logic = data.depth_logic_check || {};
                if (logic.elbow_hyperextension && logic.elbow_hyperextension.rate > 0) score -= 15;
                if (logic.knee_hyperextension && logic.knee_hyperextension.rate > 0) score -= 15;
            }
            else if (step === 4) {
                // Step 4: Physical Motion
                const kinematics = data.motion_kinematics || {};
                let speedIssues = 0;
                Object.values(kinematics).forEach(k => speedIssues += (k.unreasonable_speed_count || 0));
                if (speedIssues > 0) score -= Math.min(30, speedIssues * 2);
                
                const angles = data.joint_angles || {};
                let angleIssues = 0;
                Object.values(angles).forEach(a => angleIssues += (a.abnormal_count || 0));
                if (angleIssues > 0) score -= Math.min(30, angleIssues * 2);
            }
            else if (step === 5) {
                // Step 5: Spatial Consistency
                const ground = data.ground_plane_consistency || {};
                const meanDiff = ground.mean_diff_mm || 0;
                if (meanDiff > 100) score -= Math.min(30, (meanDiff - 100) * 0.2);
                
                const pen = data.penetration_detection || {};
                if (pen.penetration_rate_percent > 0) score -= Math.min(40, pen.penetration_rate_percent * 2);
            }
            else if (step === 6) {
                // Step 6: Time Smoothness
                const jumps = data.jump_anomalies || {};
                const totalJumps = Object.values(jumps).reduce((sum, item) => sum + (item.large_jump_count || 0), 0);
                if (totalJumps > 0) score -= Math.min(40, totalJumps * 8);
                
                const accel = data.acceleration_anomalies || {};
                const totalAccel = Object.values(accel).reduce((sum, item) => sum + (item.outlier_count || 0), 0);
                if (totalAccel > 0) score -= Math.min(30, totalAccel * 1.5);
            }
        } catch (e) {
            console.error("Fallback calculation error", e);
            return null;
        }

        score = Math.max(0, Math.round(score));
        
        if (score >= 90) level = 'Excellent';
        else if (score >= 80) level = 'Good';
        else if (score >= 60) level = 'Fair';
        else level = 'Poor';

        return { score, level };
    }

    async function updateOverview(step, resultFile) {
        const item = document.getElementById(`overview-step${step}`);
        const scoreEl = item.querySelector('.step-score');
        const statusEl = item.querySelector('.step-status');

        try {
            // Fetch the result JSON to get the score
            // Since resultFile is a relative path like 'data/...', we can fetch it directly
            const response = await fetch(resultFile);
            if (!response.ok) throw new Error('Fetch failed');
            
            // Robust Parsing for NaN/Infinity (Consistent with Step 1-6)
            const text = await response.text();
            let jsonString = text;
            jsonString = jsonString.replace(/:\s*NaN\b/g, ': null');
            jsonString = jsonString.replace(/:\s*Infinity\b/g, ': null');
            jsonString = jsonString.replace(/:\s*-Infinity\b/g, ': null');
            const data = JSON.parse(jsonString);

            let score = '--';
            let level = 'Unknown';
            
            // 1. Standardized Backend Score (Priority)
            if (data.overall_summary && data.overall_summary.quality_score) {
                const qs = data.overall_summary.quality_score;
                score = typeof qs.score === 'number' ? qs.score.toFixed(1) : qs.score;
                level = qs.level || 'Unknown';
            }
            // 2. Frontend Fallback Calculation (New)
            else {
                const fallback = calculateFallbackScore(step, data);
                if (fallback) {
                    score = fallback.score.toFixed(1);
                    level = fallback.level;
                }
                // 3. Legacy Fallback for Step 1 (Mean Error)
                else if (step === 1 && data.global_stats && typeof data.global_stats.overall_mean === 'number') {
                     score = data.global_stats.overall_mean.toFixed(2) + ' px';
                     level = data.global_stats.quality_level || 'Mean Error';
                }
                // 4. Legacy Fallback (Generic)
                else if (data.score && typeof data.score.total_score !== 'undefined') {
                    score = data.score.total_score.toFixed(1);
                    level = data.score.level || '';
                } 
            }

            scoreEl.textContent = score;
            statusEl.textContent = level;
            
            // Reset classes
            statusEl.className = 'step-status';
            item.style.borderColor = '';

            // Determine color based on score
            if (score !== '--') {
                const isPixelMetric = typeof score === 'string' && score.includes('px');
                const numScore = parseFloat(score);
                
                let isGood = false;
                let isAvg = false;

                if (step === 1 && isPixelMetric) {
                    // Lower is better for error (px)
                    if (numScore < 5) isGood = true;
                    else if (numScore < 10) isAvg = true;
                } else {
                    // Higher is better for score (0-100)
                    if (numScore >= 80) isGood = true;
                    else if (numScore >= 60) isAvg = true;
                }

                if (isGood) {
                    statusEl.classList.add('badge-success');
                    item.style.borderColor = 'rgba(52, 211, 153, 0.3)';
                } else if (isAvg) {
                    statusEl.classList.add('badge-warning');
                    item.style.borderColor = 'rgba(251, 191, 36, 0.3)';
                } else {
                    statusEl.classList.add('badge-error');
                    item.style.borderColor = 'rgba(248, 113, 113, 0.3)';
                }
            } else {
                statusEl.classList.add('badge-pending');
            }

        } catch (e) {
            console.error(`Error updating overview for step ${step}:`, e);
            statusEl.textContent = 'Error';
            statusEl.className = 'step-status badge-error';
        }
    }

    function downloadReport(step) {
        const resultFile = window[`step${step}Result`];
        if (!resultFile) return;
        
        const url = `/api/export/offline-report?type=step${step}&file=${encodeURIComponent(resultFile)}`;
        window.location.href = url;
    }

    async function runStep2() {
        const payload = {
            json_3d: document.getElementById('file-3d').value
        };

        setRunningState(2, true);

        try {
            const res = await fetch('/api/validate/step2', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            setRunningState(2, false);

            if (data.status === 'success') {
                setCompleteState(2, data.result_file);
                
                // Auto-save HTML report
                await fetch(`/api/export/offline-report?type=step2&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);
                
                return true; // Return success for chain execution
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(2, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    async function runStep3() {
        const payload = {
            json_3d: document.getElementById('file-3d').value
        };

        setRunningState(3, true);

        try {
            const res = await fetch('/api/validate/step3', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            setRunningState(3, false);

            if (data.status === 'success') {
                setCompleteState(3, data.result_file);

                await fetch(`/api/export/offline-report?type=step3&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);

                return true;
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(3, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    async function runStep4() {
        const payload = { json_3d: document.getElementById('file-3d').value };
        setRunningState(4, true);
        try {
            const res = await fetch('/api/validate/step4', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            setRunningState(4, false);
            if (data.status === 'success') {
                setCompleteState(4, data.result_file);
                await fetch(`/api/export/offline-report?type=step4&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);
                return true;
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(4, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    async function runStep5() {
        const payload = { json_3d: document.getElementById('file-3d').value };
        setRunningState(5, true);
        try {
            const res = await fetch('/api/validate/step5', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            setRunningState(5, false);
            if (data.status === 'success') {
                setCompleteState(5, data.result_file);
                await fetch(`/api/export/offline-report?type=step5&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);
                return true;
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(5, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    async function runStep6() {
        const payload = { json_3d: document.getElementById('file-3d').value };
        setRunningState(6, true);
        try {
            const res = await fetch('/api/validate/step6', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            setRunningState(6, false);
            if (data.status === 'success') {
                setCompleteState(6, data.result_file);
                await fetch(`/api/export/offline-report?type=step6&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);
                return true;
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(6, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    // Clear all settings and reset UI
    function clearAllSettings() {
        // Reset file selections
        document.getElementById('file-3d').selectedIndex = -1;
        document.getElementById('file-side').selectedIndex = -1;
        document.getElementById('file-45').selectedIndex = -1;

        // Reset UI states for all steps
        for (let i = 1; i <= 6; i++) {
            const btn = document.getElementById(`btn-run-step${i}`);
            const status = document.getElementById(`status-step${i}`);
            const viewBtn = document.getElementById(`btn-view-step${i}`);
            const dlBtn = document.getElementById(`btn-download-step${i}`);
            const overviewItem = document.getElementById(`overview-step${i}`);
            
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'åŸ·è¡Œåˆ†æ';
            }
            if (status) status.classList.remove('visible');
            if (viewBtn) {
                viewBtn.style.display = 'none';
                viewBtn.href = '#';
            }
            if (dlBtn) dlBtn.style.display = 'none';
            
            // Reset Overview
            if (overviewItem) {
                const scoreEl = overviewItem.querySelector('.step-score');
                const statusEl = overviewItem.querySelector('.step-status');
                
                if (scoreEl) scoreEl.textContent = '--';
                if (statusEl) {
                    statusEl.textContent = 'Pending';
                    statusEl.className = 'step-status badge-pending';
                }
                overviewItem.style.borderColor = '';
            }
            
            window[`step${i}Result`] = null;
        }
    }

    // Run all tests sequentially
    async function runAllTests() {
        // Check if files are selected
        if (!document.getElementById('file-3d').value) {
            alert('è«‹å…ˆé¸æ“‡ 3D Trajectory JSON æª”æ¡ˆ');
            return;
        }

        const openReport = (step) => {
            const btn = document.getElementById(`btn-view-step${step}`);
            if (btn && btn.href) window.open(btn.href, '_blank');
        };

        // Run Step 1
        if (await runStep1()) openReport(1);
        else return;
        
        // Run Step 2
        if (await runStep2()) openReport(2);
        else return;

        // Run Step 3
        if (await runStep3()) openReport(3);
        else return;

        // Run Step 4
        if (await runStep4()) openReport(4);
        else return;

        // Run Step 5
        if (await runStep5()) openReport(5);
        else return;

        // Run Step 6
        if (await runStep6()) openReport(6);
    }

    // Modified runStep1 to return success status
    async function runStep1() {
        const matrices = getMatrices();
        if (!matrices) return false;

        const payload = {
            json_3d: document.getElementById('file-3d').value,
            json_2d_side: document.getElementById('file-side').value,
            json_2d_45: document.getElementById('file-45').value,
            p1: matrices.p1,
            p2: matrices.p2
        };

        setRunningState(1, true);

        try {
            const res = await fetch('/api/validate/step1', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            setRunningState(1, false);

            if (data.status === 'success') {
                setCompleteState(1, data.result_file);
                
                // Auto-save HTML report
                await fetch(`/api/export/offline-report?type=step1&file=${encodeURIComponent(data.result_file)}&save_to_disk=true`);
                
                return true;
            } else {
                alert('éŒ¯èª¤: ' + data.error);
                return false;
            }
        } catch (e) {
            setRunningState(1, false);
            alert('è«‹æ±‚å¤±æ•—: ' + e);
            return false;
        }
    }

    // åˆå§‹åŒ–
    loadFolders();
    loadConfigs();
</script>

</body>
</html>
