<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>3D Trajectory Viewer (Plotly)</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
    body { margin: 0; background: #111; font-family: Arial; overflow: hidden; }
    #controls {
        position: absolute; top: 10px; left: 10px;
        z-index: 100; color: white;
        background: rgba(0,0,0,0.6);
        padding: 15px; border-radius: 8px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.1);
    }
    #plot { width: 100vw; height: 100vh; }
    label { display: block; margin-top: 5px; cursor: pointer; }
</style>
</head>
<body>

<div id="controls">
    <strong>Choose JSON File:</strong><br>
    <input type="file" id="jsonFile" accept=".json" style="margin-top: 5px;">
    
    <div style="margin-top: 10px; border-top: 1px solid #555; padding-top: 5px;">
        <label><input type="checkbox" id="autoPlay" checked> Auto Play</label>
    </div>

    <div id="info" style="margin-top: 10px; color: #aaa; font-size: 0.9em;">Waiting for file...</div>
</div>

<div id="plot"></div>

<script>
    // 定義骨架連接關係
    const bones = [
        ["nose", "left_eye"], ["nose", "right_eye"],
        ["left_eye", "left_ear"], ["right_eye", "right_ear"],
        ["left_shoulder", "right_shoulder"],
        ["left_shoulder", "left_elbow"], ["left_elbow", "left_wrist"],
        ["right_shoulder", "right_elbow"], ["right_elbow", "right_wrist"],
        ["left_shoulder", "left_hip"], ["right_shoulder", "right_hip"],
        ["left_hip", "right_hip"],
        ["left_hip", "left_knee"], ["left_knee", "left_ankle"],
        ["right_hip", "right_knee"], ["right_knee", "right_ankle"]
    ];

    let frames = [];
    let currentFrameIdx = 0;
    let isPlaying = false;
    let animationTimer = null;

    // 初始化 Plotly
    const layout = {
        scene: {
            aspectmode: 'data',
            xaxis: { title: 'X', backgroundcolor: '#111', gridcolor: '#333', showbackground: true, zerolinecolor: '#555' },
            yaxis: { title: 'Y', backgroundcolor: '#111', gridcolor: '#333', showbackground: true, zerolinecolor: '#555' },
            zaxis: { title: 'Z', backgroundcolor: '#111', gridcolor: '#333', showbackground: true, zerolinecolor: '#555' },
            // 設定相機視角：Y 軸朝上 (Up)，模擬真實世界觀看角度
            camera: { 
                eye: {x: 0, y: 0.2, z: 2.5}, // 從正面稍微偏上觀看
                up: {x: 0, y: 1, z: 0}       // 設定 Y 軸為垂直向上 (Standard World Up)
            }
        },
        paper_bgcolor: '#111',
        plot_bgcolor: '#111',
        margin: { l: 0, r: 0, b: 0, t: 0 },
        showlegend: false,
        uirevision: 'true' // 保持相機視角不重置，允許播放時 360 度旋轉
    };

    Plotly.newPlot('plot', [], layout);

    // 讀取檔案
    document.getElementById("jsonFile").addEventListener("change", function(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let content = e.target.result.trim();
                if (content.charCodeAt(0) === 0xFEFF) content = content.slice(1); // Remove BOM

                const json = JSON.parse(content);
                if (!Array.isArray(json) || json.length === 0) {
                    alert("JSON format error: Expected an array of frames.");
                    return;
                }

                frames = json;
                currentFrameIdx = 0;
                console.log(`Loaded ${frames.length} frames`);
                
                if (document.getElementById('autoPlay').checked) {
                    startAnimation();
                } else {
                    updatePlot();
                }

            } catch (err) {
                console.error(err);
                alert("Invalid JSON: " + err.message);
            }
        };
        reader.readAsText(file);
    });

    // 監聽控制項變更
    document.getElementById('autoPlay').addEventListener('change', (e) => {
        if (e.target.checked) startAnimation();
        else stopAnimation();
    });

    function startAnimation() {
        if (isPlaying) return;
        isPlaying = true;
        animate();
    }

    function stopAnimation() {
        isPlaying = false;
        if (animationTimer) clearTimeout(animationTimer);
    }

    function animate() {
        if (!isPlaying || frames.length === 0) return;
        
        updatePlot();
        currentFrameIdx = (currentFrameIdx + 1) % frames.length;
        
        // 控制 FPS (約 30fps)
        animationTimer = setTimeout(() => requestAnimationFrame(animate), 33);
    }

    function updatePlot() {
        if (frames.length === 0) return;

        const frame = frames[currentFrameIdx];

        // 準備骨架線段數據
        const x = [], y = [], z = [];
        
        bones.forEach(pair => {
            const p1 = frame[pair[0]];
            const p2 = frame[pair[1]];
            
            if (p1 && p2) {
                x.push(p1.x, p2.x, null);
                y.push(p1.y, p2.y, null);
                z.push(p1.z, p2.z, null);
            }
        });

        // 準備關節點數據
        const jx = [], jy = [], jz = [];
        Object.keys(frame).forEach(key => {
            const p = frame[key];
            if (key !== 'frame' && p && typeof p.x === 'number') {
                jx.push(p.x);
                jy.push(p.y);
                jz.push(p.z);
            }
        });

        const traceLines = {
            type: 'scatter3d',
            mode: 'lines',
            x: x, y: y, z: z,
            line: { color: '#00eaff', width: 5 },
            hoverinfo: 'none'
        };

        const traceJoints = {
            type: 'scatter3d',
            mode: 'markers',
            x: jx, y: jy, z: jz,
            marker: { color: '#ff0080', size: 4 },
            hoverinfo: 'none'
        };

        // 使用 Plotly.react 更新數據 (比 newPlot 快)
        Plotly.react('plot', [traceLines, traceJoints], layout);

        document.getElementById('info').innerText = `Frame: ${currentFrameIdx} / ${frames.length}`;
    }
</script>

</body>
</html>
